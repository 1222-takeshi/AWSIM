# TrafficSimulation

## Abstract
`Traffic Simulation` simulates traffic situation follow traffic rules.<br>
Spawn points (Spawnable Lanes) and spawnable vehicles can be configured using components and `Traffic Simulation` simulates traffic situation following configuration.

<a href="./top.png" data-lightbox="Traffic Simulation" data-title="" data-alt="Traffic Simulation"><img src="./top.png"></a>

### Overview
`Traffic Simulation` consists of the following components:

| Component | Description |
|---|---|
| TrafficSimulator | Collecting all traffic simulators and managing the spawning and simulating process. |
| NpcVehicleSpawner | Get Npc vehicle states and updating simulation steps. |
| NpcVehicleSimulator | Spawning random Npc vehicle in spawning lanes. |
| RandomTrafficSimulator | Managing lifecycle of NPCs and simulating NPC behaviours. |
| TrafficLane<br>TrafficLight<br>TrafficIntersection<br>StopLine | Traffic entities. |
| NpcVehicle | Vehicle models (NPCs) controlled by `RandomTrafficSimulator`. |

### Configuration
`Traffic Simulation` can be configured from `TrafficSimulator` component.

The configurable elements are listed in the following table:

#### General Settings

<a href="./config0.png" data-lightbox="Configulations0" data-title="" data-alt="Configulations0"><img src="./config0.png"></a>

| Parameter | Description |
|---|---|
| Ego Vehicle | Ego vehicle handler. If not set, the manager creates a dummy ego.<br>This reference is also set automatically when the Ego spawns via the traffic simulator. |
| Seed | Seed value for random generator. |
| Traffic Intersections | The field that is set `TrafficIntersection` objects.<br>`TrafficIntersection` to be set is controlled by `Traffic Simulation`. |

#### NPC Vehicle Settings

<a href="./config1.png" data-lightbox="Configulations1" data-title="" data-alt="Configulations1"><img src="./config1.png"></a>

| Parameter | Description |
|---|---|
| Vehicle Config | Parameters for NPC vehicle control.<br/>`Sudden Deceleration` is a deceleration related to emergency braking. |
| Obstacle Layer Mask | The obstacle layer for raytracing the collision distances. |
| Ground Layer Mask | The Ground layer for raytracing the collision distances. |
| Max Vehicle Count | The maximum number of vehicles that can simultaneously live in the scene.<br>Lowering this value results in less dense traffic but improves the simulator's performance. |
| Spawn Distance To Ego | The minimal distance between the EGO and the NPC to spawn. |

#### Debug

<a href="./config2.png" data-lightbox="Configulations2" data-title="" data-alt="Configulations2"><img src="./config2.png"></a>

| Parameter | Description |
|---|---|
| Show Gizmos | Enable the checkbox to show all visualization using editor gizmos. |
| Show Yielding Phase | Enable the checkbox to show editor gizmos that visualize `Yielding Phase` of NPCs. |
| Show Obstacle Checking | Enable the checkbox to show editor gizmos that visualize `Obstacle Checking` phase of NPCs. |
| Show Spawn Points | Enable the checkbox to show editor gizmos that visualize `Spawn Points` where NPCs is generated. |

#### Random Traffic Sims

<a href="./config3.png" data-lightbox="Configulations3" data-title="" data-alt="Configulations3"><img src="./config3.png"></a>

| Parameter | Description |
|---|---|
| Enable Simulation | Enable the checkbox to `Random Traffic Sims` which spawn NPC vehicles randomly. |
| TrafficSim Npc Vehicle Prefabs| Prefabs representing controlled vehicles.<br/>They must have `NPCVehicle` component attached. |
| Spawnable TrafficLanes | `TrafficLane` components where NPC vehicles can be spawned during traffic simulation. |
| Enable Spawn Count Limit | Enable the checkbox to limit of vehicle spawning. |
| Spawn Count Limit | The number of limit of vehicles spawning. |

### Gizmos
Gizmos are useful for checking current behavior of NPCs and its causes.<br>
Gizmos have a high computational load so please disable them if the simulation is laggy.

The visualizable elements are listed in the following table:

| Shape | Description |
|---|---|
| Rectangle | `Yielding Phase` of each NPCs to avoid colliding with the other NPCs. |
| Arrow | `Obstacle Checking` of each NPCs to stop in front of the obstacle. |
| Diamond | `Spawn Points` where NPCs is generated by `Random Traffic Sims`. |

<a href="./gizmo.png" data-lightbox="Gizmo" data-title="" data-alt="Gizmo"><img src="./gizmo.png"></a>

## Instruction
To use `Traffic Simulation`, please follow the steps below.

For the preparation, the following must be prepared:

- 3D map (.fbx)
- lanelet map (.osm)

### 1. Place Traffic Simulator
Create empty `GameObject` (should be named `TrafficSimulator`).<br>
Attach this object to `TrafficSimulator` component.

(optional) To place objects which is generated later, you may creat empty objects named `TrafficIntersections` and `NPCPedestrians`.

<a href="./hierarchy.png" data-lightbox="Place Traffic Simulator" data-title="" data-alt="Place Traffic Simulator"><img src="./hierarchy.png"></a>

### 2. TrafficIntersection and LaneletTrafficLight settings
Please place intersection objects and attach `LaneletTrafficLight` script.<br>
Then, please you set traffic lights to intersection.

<a href="./traffic_intersection.png" data-lightbox="Traffic Intersection" data-title="" data-alt="Traffic Intersection"><img src="./traffic_intersection.png"></a>

Please configure `TrafficIntersection` and `LaneletTrafficLight` components as the following:

1. Add a empty `GameObject` as a child object of `TrafficIntersections` hierarchy
    1. The `GameObject` should be named `TrafficIntersection.x`
    2. The `Transform` of `GameObject` should be set on the target intersection
2. Attach a `TrafficIntersection` component to the intersection game object
3. Attach `LaneletTrafficLight` to traffic light objects placed on the target intersection
<a href="./traffic_light.png" data-lightbox="Traffic Light" data-title="" data-alt="Traffic Light"><img src="./traffic_light.png"></a>
4. Modify `Bulb Material Config` as follow images<br>
vehicle traffic light<br>
<a href="./bulb_vehicle.png" data-lightbox="Bulb Vehicle" data-title="" data-alt="Bulb Vehicle"><img src="./bulb_vehicle.png"></a><br>
pedestrian traffic light<br>
<a href="./bulb_pedestrian.png" data-lightbox="Bulb Pedestrian" data-title="" data-alt="Bulb Pedestrian"><img src="./bulb_pedestrian.png"></a>
    1. If there are wrong order of bulb, modify each `Bulb Material Config`
5. Set traffic light objects attached `LaneletTrafficLight` in step. 3 to `TrafficLightGroups` in `TrafficIntersection`
    1. Traffic lights which should light same sequences should be set on same `TrafficLightGroups`

!!! warning
    Do not attach `LaneletTrafficLight` to traffic lights which are not set to `TrafficIntersection`.<br>
    It causes errors.

!!! info
    For detailed settings of `Bulb Material Config`, see [here](../../Entity/Infra/TrafficLight/index.md).

#### Modify `Lighting Sequences`
If you need to set an arbitrary signal control pattern, you can modify it in `Lighting Sequences` field.

Create any number of elements of `Lighting Sequences` and set parameters for each one.<br>
When the scene plays, the `Lighting Sequences` will execute sequentially from `Element 0`.<br>
In addition, when the last element completes, the sequence will loop back to `Element 0`.

<a href="./lighting_sequences.png" data-lightbox="Lighting Sequences" data-title="" data-alt="Lighting Sequences"><img src="./lighting_sequences.png"></a>

The `Waypoint settings` parameters are listed in the following table:

Lighting Sequences

| Parameter | Description |
|---|---|
| Interval Sec | Duration for which this sequence continues. |
| Group Lighting Orders | Settings for lighting each `TrafficLightGroups`. |

Group Lighting Orders

| Parameter | Description |
|---|---|
| Group | Target `TrafficLightGroups`. |
| Bulb Data | Setting for lighting each bulb in traffic lights within `TrafficLightGroups`. |

Bulb Data

| Parameter | Description |
|---|---|
| Type | Target bulb. |
| Color | Color of lighting on target bulb. |
| Status | Type of lighting. (Solid On, Solid Off and Flashing) |

#### Set right of ways on uncontrolled intersections
On intersections without traffic lights, it is needed to set the right of way of TrafficLane manually for the vehicles to operate properly.

Please configure `TrafficLane` components as the following:

1. Select a straight lane that should be right of way in the intersection
<a href="./right_of_ways_before.png" data-lightbox="Right of Ways Before" data-title="" data-alt="Right of Ways Before"><img src="./right_of_ways_before.png"></a>
    1. The selected lane should be highlighted
2. Click the `Set RightOfWays` button to give the lane priority over other lanes
<a href="./right_of_ways_after.png" data-lightbox="Right of Ways Before" data-title="" data-alt="Right of Ways Before"><img src="./right_of_ways_after.png"></a>

Please check if all lanes that intersect with the selected lane are highlighted yellow.<br>
This means that the right of way was applied correctly.

### 3. Load lanelet
`LaneletLoader` can load a lanelet map and create `TrafficLane` and `StopLine`.
In addition, `LaneletLoader` set parameter of traffic rules to `TrafficLane`, `StopLine` and traffic lights.<br>
`LaneletLoader` can be performed by opening `AWSIM -> Common -> Load Lanelet` at the toolbar of Unity Editor.

<a href="./load_lanelet_tool_bar.png" data-lightbox="Tool Bar" data-title="" data-alt="Tool Bar"><img src="./load_lanelet_tool_bar.png"></a>

Please use `LaneletLoader` as the following:
1. Fill in `Osm` field with a lanelet map (`.osm`) you prepared, `Root Object` field with a `TrafficSimulator` object.<br>
2. Adjust `Waypoint settings` parameters for the loading process if needed.<br>
3. To load the lanelet map, please click `Load` button.

<a href="./load_lanelet.png" data-lightbox="Load Lanelet" data-title="" data-alt="Load Lanelet"><img src="./load_lanelet.png"></a>

The `Waypoint settings` parameters are listed in the following table:

| Parameter | Description |
|---|---|
| Resolution | Resolution of resampling. Lower values provide better accuracy at the cost of processing time. |
| Min Delta Length | Minimum length(m) between adjacent points. |
| Min Delta Angle | Minimum angle(deg) between adjacent edges.<br>Lowering this value produces a smoother curve. |

`TrafficLane`, `StopLine` and `TrafficLight` will be generated and placed as child objects of the `Root Object`.<br>
You can check their visual representation by clicking consecutive elements in the scene hierarchy.

<a href="./hierarchy2.png" data-lightbox="Hierarchy" data-title="" data-alt="Hierarchy"><img src="./hierarchy2.png"></a>

### 4. TrafficSimulator setting

<a href="./traffic_simulator.png" data-lightbox="Traffic Simulator" data-title="" data-alt="Traffic Simulator"><img src="./traffic_simulator.png"></a>

Please configure `TrafficSimulator` component as the following:

1. Fill in `Ego Vehicle` field with EGO vehicle
    1. Example: `EgoVehicle/Lexus RX450h 2015`
2. Change `Obstacle Layer Mask` and `Ground Layer Mask` field to `Everything`
3. Fill in `Traffic Intersections` field with `TrafficIntersection` objects
4. Fill in `Random Traffic Sims` field
    1. Fill in `Traffic Sim Npc Vehicle Prefab` field with vehicle prefabs what you want to spawn
        1. Prefabs is in `Assets/Awsim/Prefabs/Usecase/TrafficSimulation/`
    2. Fill in `Spawnable Traffic Lanes` field with `TrafficLane` where you want to spawn vehicles

!!! info
    For detailed settings of `TrafficSimulator`, see [here](#configulations).

### 5. Place Pedestrian (optional)
You can place pedestrian NPCs if needed.<br>
Pedestrians can animated and walk around where they are placed.<br>
Direction which pedestrian start to walking can be set in `Transform` of it.

<a href="./pedestrian.png" data-lightbox="Pedestrian" data-title="" data-alt="Pedestrian"><img src="./pedestrian.png"></a>

Please configure pedestrian NPCs as the following:

1. Place pedestrian prefabs on a scene
    1. Prefabs is in `Assets/Awsim/Prefabs/Entity/Npc/Pedestrian/`
    2. Pedestrians should be child object of `NPCPedestrians` hierarchy
2. Attach `SimplePedestrianWalkerController` component to pedestrians
3. (optional) Configure parameters of `SimplePedestrianWalkerController`

The parameters of `SimplePedestrianWalkerController` are listed in the following table:

| Parameter | Description |
|---|---|
| Duration | Duration at which the pedestrian walk. |
| Speed | Speed at which the pedestian walk. |

### 6. Call methods of `TrafficSimulator`
To enable `Traffic Simulation`, some methods of `TrafficSimulator` should be called from callback of `MonoBehaviour`.

Please create or open class which is inherit `MonoBehaviour` and make field of `TrafficSimulator`.<br>
Then, add description of calling method of `TrafficSimulator`.

The method should be called are listed in the following table:

| Method | Description |
|---|---|
| Initialize() | Should be called Start() callback. |
| OnUpdate() | Should be called Update() callback. |
| OnFixedUpdate() | Should be called FixedUpdate() callback. |

!!! info
    AWSIM includes `AutowareSimulationDemo` scene.<br>
    Please refer to:<br>
    * `Assets/Awsim/Scenes/AutowareSimulationDemo/AutowareSimulationDemo.cs`<br>
    * `Assets/Awsim/Scenes/AutowareSimulationDemo.unity` scene

#### Call methods of Pedestrian (optional)
To move Pedestrian, some methods of `SimplePedestrianWalkerController` should be called same as `TrafficSimulator`.

Please create or open class which is inherit `MonoBehaviour` and make field of `SimplePedestrianWalkerController[]`.<br>
Then, add description of calling method of each element of `SimplePedestrianWalkerController[]` using for loop.

The method should be called are listed in the following table:

| Method | Description |
|---|---|
| Initialize() | Should be called Start() callback. |
| OnUpdate() | Should be called Update() callback. |
| OnFixedUpdate() | Should be called FixedUpdate() callback. |

# Traffic Simulation
The `Traffic Simulation` simulates traffic situation follow traffic rules.<br>
Spawn point (Spawnable Lanes) and spawnable vehicle can be configured in `Unity Editor` component and `Traffic Simulation` simulates traffic situation following configuration.

![Traffic Simulation](./top.png)

## Overview

## Configulations
`Traffic Simulation` can be configured from `Unity Editor` component (`TrafficSimulator.cs`).

The configurable elements are listed in the following table:

### General Settings

![Configulations0](./config0.png)

| Parameter | Description |
|---|---|
| Ego Vehicle | Ego vehicle handler. If not set, the manager creates a dummy ego. This reference is also set automatically when the Ego spawns via the traffic simulator |
| Seed | Seed value for random generator |
| Traffic Intersections | The field that is set `TrafficIntersection` objects. `TrafficIntersection` to be set is controlled by `Traffic Simulation` |

### NPC Vehicle Settings

![Configulations1](./config1.png)

| Parameter | Description |
|---|---|
| Vehicle Config | Parameters for NPC vehicle control<br/>`Sudden Deceleration` is a deceleration related to emergency braking |
| Obstacle Layer Mask | Obstacle layer for raytracing the collision distances |
| Ground Layer Mask | Ground layer for raytracing the collision distances |
| Max Vehicle Count | A maximum number of vehicles that can simultaneously live in the scene. Lowering this value results in less dense traffic but improves the simulator's performance |
| Spawn Distance To Ego | A minimal distance between the EGO and the NPC to spawn |

### Debug

![Configulations2](./config2.png)

| Parameter | Description |
|---|---|
| Show Gizmos | Enable the checkbox to show all visualization using editor gizmos |
| Show Yielding Phase | Enable the checkbox to show editor gizmos that visualize `Yielding Phase` (to the other NPCs) of NPCs |
| Show Obstacle Checking | Enable the checkbox to show editor gizmos that visualize `Obstacle Checking` phase of NPCs |
| Show Spawn Points | Enable the checkbox to show editor gizmos that visualize `Spawn Points` where NPCs is generated |

### Random Traffic Sims

![Configulations3](./config3.png)

| Parameter | Description |
|---|---|
| Enable Simulation | Prefabs representing controlled vehicles.<br/> They must have `NPCVehicle` component attached |
| TrafficSim Npc Vehicle Prefabs| Prefabs representing controlled vehicles.<br/> They must have `NPCVehicle` component attached |
| Spawnable TrafficLanes | `TrafficLane` components where NPC vehicles can be spawned during traffic simulation |
| Enable Spawn Count Limit | `TrafficLane` components where NPC vehicles can be spawned during traffic simulation |
| Spawn Count Limit | `TrafficLane` components where NPC vehicles can be spawned during traffic simulation |

## Gizmos
Gizmos are useful for checking current behavior of NPCs and its causes.<br>
Gizmos have a high computational load so please disable them if the simulation is laggy.

The visualizable elements are listed in the following table:

| Shape | Description |
|---|---|
| Rectangle | `Yielding Phase` of each NPCs to avoid colliding with the other NPCs |
| Arrow | `Obstacle Checking` of each NPCs to stop in front of the obstacle |
| Diamond | `Spawn Points` where NPCs is generated by `Traffic Simulator` |

![Gizmo](./gizmo.png)

# Instruction

## Preparation
### Environment
### Lanelet

## TrafficLight setting
Please attach `LaneletTrafficLight` component to all traffic light GameObjects placed on scene.

## Locate Pedestrian (optional)

## Load lanelet
`LaneletLoader` can load lanelet and set parameter of traffic rules to `TrafficLane`, `StopLine` and `TrafficLight`.<br>
`LaneletLoader` can be performed by opening `AWSIM -> Random Traffic -> Load Lanelet` at the toolbar of Unity Editor.

[img]

Please fill in `a` field with lanelet map (`.osm`) you prepared, in `a` field with `b` object.<br>
Please adjust the parameters for the loading process if needed.<br>
To load lanelet map, please click `Load` button.

[img]

The `Waypoint settings` parameters are described in the following table:

| Parameter | Description |
|---|---|
| Resolution | Resolution of resampling. Lower values provide better accuracy at the cost of processing time |
| Min Delta Length | Minimum length(m) between adjacent points |
| Min Delta Angle | minimum angle(deg) between adjacent edges. Lowering this value produces a smoother curve |

Environment components should be generated and placed as child objects of the Environment GameObject.<br>
You can check their visual representation by clicking consecutive elements in the scene hierarchy.

## TrafficIntersection setting

## TrafficSimulator setting

## Reference Components
To enable `Traffic Simulation`, please fill in following fields in `AutowareSimulationDemo.cs`.

[img]

### TrafficSimulator
Please fill in `a` field in `AutowareSimulationDemo.cs` with a object which is attached `TrafficSimulator.cs`.

### NPCPedestrians (optional)
Please fill in `a` list in  `AutowareSimulationDemo.cs` with `Pedestrian` if you located.
